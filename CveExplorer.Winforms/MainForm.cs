using CveExplorer.Exceptions;

namespace CveExplorer.Winforms;

public partial class MainForm : Form
{
    private Cve? _cve;
    private readonly CveApi _api = new();

    public MainForm()
    {
        InitializeComponent();
    }

    private async void btBuscarCve_Click(object sender, EventArgs e)
    {
        try
        {
            _cve = await _api.GetById(txtCodigoCve.Text ?? "");
        }
        catch (InvalidCveFormatException ex)
        {
            MessageBox.Show(ex.Message, "CVE Id inválido", MessageBoxButtons.OK, MessageBoxIcon.Error);
            return;
        }
        catch (CveNotFoundException ex)
        {
            MessageBox.Show(ex.Message, "Não encontrado", MessageBoxButtons.OK, MessageBoxIcon.Error);
            return;
        }
        
        txtSummary.Text = _cve.Summary;
        txtPublished.Text = _cve.Published.ToString(Constants.DateFormat);
        txtModified.Text = _cve.Modified.ToString(Constants.DateFormat);
        txtLastModified.Text = _cve.LastModified.ToString(Constants.DateFormat);
        txtAssigner.Text = _cve.Assigner;

        txtAuthentication.Text = _cve.Access?.Authentication ?? "";
        txtComplexity.Text = _cve.Access?.Complexity ?? "";
        txtVector.Text = _cve.Access?.Vector ?? "";


        txtCwe.Text = _cve.Cwe;

        txtAvailability.Text = _cve.Impact?.Availability ?? "";
        txtConfidentiality.Text = _cve.Impact?.Confidentiality ?? "";
        txtIntegrity.Text = _cve.Impact?.Integrity ?? "";

        listViewReferences.Items.Clear();
        listViewReferences.Items.AddRange(
            _cve.References?.Select(reference => new ListViewItem(reference)).ToArray() ?? Array.Empty<ListViewItem>()
        );

        var bs = new BindingSource
        {
            DataSource = _cve.Capec
        };

        dataGridCapec.DataSource = bs;
    }

    private void dataGridCapec_CellDoubleClick(object sender, DataGridViewCellEventArgs e)
    {
        var id = (Capec)dataGridCapec.Rows[e.RowIndex].DataBoundItem;
        var form = new FormCapecItem(id);
        form.ShowDialog();
    }


    private void linkInfoCvss_Click(object sender, EventArgs e)
    {
        if (_cve is null)
            return;

        var form = new CvssInfoForm(_cve.CvssVector, _cve.Cvss, _cve.CvssTime);
        form.ShowDialog();
    }
}
